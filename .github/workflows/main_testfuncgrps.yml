
name: Build and deploy Python project to Azure Function App - testfuncgrps

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # IMPORTANT:
      # For Azure Functions (especially Flex), you usually do NOT need to create a venv in CI.
      # Azure will install dependencies during build/deploy depending on the plan/pipeline.
      # Keep requirements.txt at the repo root.

      - name: Create deployment zip (exclude venv, git, workflow files)
        run: |
          zip -r release.zip . \
            -x "venv/*" \
               ".git/*" \
               ".github/*" \
               "*.pyc" \
               "__pycache__/*"

      - name: Deploy to Azure Functions
        uses: Azure/functions-action@v1
        with:
          app-name: 'testfuncgrps'
          slot-name: 'Production'
          package: release.zip
          publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE_4999A99F89F24FF994EDEE34B1E8825B }}
          sku: 'flexconsumption'
